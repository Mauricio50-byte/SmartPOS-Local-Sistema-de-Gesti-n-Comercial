<div class="usuarios-container">
  <div class="page-header">
    <div>
      <h2>Gestión de Usuarios</h2>
      <p class="subtitle">Administra el acceso, roles y permisos del personal</p>
    </div>
    <ion-button color="primary" shape="round" (click)="mostrarFormularioCrear()">
      <ion-icon name="person-add-outline" slot="start"></ion-icon>
      Nuevo Usuario
    </ion-button>
  </div>

  <!-- Lista de usuarios -->
  <div class="usuarios-grid">
    <div *ngFor="let usuario of usuarios" class="usuario-card">
      <div class="card-header">
        <div class="usuario-avatar" [class.admin]="usuario.roles && usuario.roles.includes('ADMIN')" [class.trabajador]="usuario.roles && usuario.roles.includes('TRABAJADOR')">
          <span class="avatar-initial">{{ (usuario.nombre || 'U') | slice:0:1 | uppercase }}</span>
        </div>
        <div class="status-badge" [class.activo]="usuario.activo" [class.inactivo]="!usuario.activo">
          {{usuario.activo ? 'Activo' : 'Inactivo'}}
        </div>
      </div>

      <div class="card-body">
        <h3 class="usuario-nombre">{{usuario.nombre}}</h3>
        <p class="usuario-email">{{usuario.correo}}</p>
        
        <div class="roles-container">
          <div class="role-badge" *ngFor="let rol of usuario.roles">
            {{ rol | titlecase }}
          </div>
          <div class="role-badge empty" *ngIf="!usuario.roles || usuario.roles.length === 0">
            Sin roles asignados
          </div>
        </div>
      </div>

      <div class="card-actions">
        <ion-button fill="clear" size="small" (click)="editarUsuario(usuario)" title="Editar información básica">
          <ion-icon slot="icon-only" name="create-outline"></ion-icon>
        </ion-button>
        
        <ion-button fill="clear" size="small" color="secondary" (click)="gestionarPermisos(usuario)" title="Gestionar Permisos y Módulos">
          <ion-icon slot="icon-only" name="shield-checkmark-outline"></ion-icon>
        </ion-button>

        <ion-button fill="clear" size="small" color="tertiary" (click)="cambiarContrasena(usuario.id, 'dummy')" title="Cambiar Contraseña">
           <ion-icon slot="icon-only" name="key-outline"></ion-icon>
        </ion-button>

        <ion-button 
          fill="clear" 
          size="small" 
          [color]="usuario.activo ? 'danger' : 'success'" 
          (click)="toggleEstadoUsuario(usuario)"
          [title]="usuario.activo ? 'Desactivar usuario' : 'Activar usuario'"
          [disabled]="usuario.correo === 'admin@sistema-pos.local'">
          <ion-icon slot="icon-only" name="power-outline"></ion-icon>
        </ion-button>

        <ion-button 
          fill="clear" 
          size="small" 
          color="danger" 
          (click)="eliminarUsuario(usuario)"
          title="Eliminar usuario"
          [disabled]="usuario.correo === 'admin@sistema-pos.local'">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Estado vacío -->
  <div *ngIf="usuarios.length === 0" class="empty-state">
    <div class="empty-icon">
      <ion-icon name="people-outline"></ion-icon>
    </div>
    <h3>No hay usuarios registrados</h3>
    <p>Comienza creando un nuevo usuario con el botón superior.</p>
  </div>
</div>

<!-- Modal para crear/editar usuario -->
<ion-modal [isOpen]="mostrarFormulario" (didDismiss)="cerrarFormulario()" class="user-form-modal">
  <ng-template>
    <ion-header class="ion-no-border">
      <ion-toolbar>
        <ion-title>{{ isEditMode ? 'Editar Usuario' : 'Registrar Nuevo Usuario' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarFormulario()" color="medium">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <form [formGroup]="formgroup" (ngSubmit)="guardarUsuario()" class="professional-form">
        
        <div class="form-section">
          <h4>Información Personal</h4>
          <div class="form-grid">
            <div class="form-group">
              <ion-label position="stacked">Nombre Completo <ion-text color="danger">*</ion-text></ion-label>
              <ion-input formControlName="nombre" type="text" placeholder="Ej. Juan Pérez" fill="outline"></ion-input>
              <div class="error-msg" *ngIf="formgroup.get('nombre')?.invalid && formgroup.get('nombre')?.touched">
                Nombre es requerido (min 3 caracteres)
              </div>
            </div>

            <div class="form-group">
              <ion-label position="stacked">Correo Electrónico <ion-text color="danger">*</ion-text></ion-label>
              <ion-input formControlName="correo" type="email" placeholder="juan@ejemplo.com" fill="outline"></ion-input>
              <div class="error-msg" *ngIf="formgroup.get('correo')?.invalid && formgroup.get('correo')?.touched">
                Correo válido es requerido
              </div>
            </div>
          </div>
        </div>

        <div class="form-section" *ngIf="!isEditMode">
          <h4>Seguridad</h4>
          <div class="form-group">
            <ion-label position="stacked">Contraseña Inicial <ion-text color="danger">*</ion-text></ion-label>
            <ion-input formControlName="passwordHash" type="password" placeholder="Mínimo 6 caracteres" fill="outline"></ion-input>
            <div class="error-msg" *ngIf="formgroup.get('passwordHash')?.invalid && formgroup.get('passwordHash')?.touched">
              Contraseña requerida (min 6 caracteres)
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Acceso y Estado</h4>
          <div class="form-grid">
            <div class="form-group">
              <ion-label position="stacked">Rol Principal <ion-text color="danger">*</ion-text></ion-label>
              <ion-select formControlName="rol" placeholder="Seleccionar rol" fill="outline" interface="action-sheet">
                <ion-select-option value="ADMIN">Administrador</ion-select-option>
                <ion-select-option value="TRABAJADOR">Trabajador</ion-select-option>
              </ion-select>
              <p class="helper-text">Define el nivel base de privilegios.</p>
            </div>

            <div class="form-group">
              <ion-label position="stacked">Estado de la Cuenta</ion-label>
              <ion-select formControlName="activo" placeholder="Seleccionar estado" fill="outline" interface="action-sheet">
                <ion-select-option [value]="true">Activo (Permitir acceso)</ion-select-option>
                <ion-select-option [value]="false">Inactivo (Bloquear acceso)</ion-select-option>
              </ion-select>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <ion-button expand="block" type="submit" color="primary" [disabled]="formgroup.invalid" shape="round" class="submit-btn">
            <ion-icon slot="start" [name]="isEditMode ? 'save-outline' : 'person-add-outline'"></ion-icon>
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Usuario' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
