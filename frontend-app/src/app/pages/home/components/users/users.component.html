<div class="usuarios-container">
  <div class="page-header">
    <div>
      <h2>Gestión de Usuarios</h2>
      <p class="subtitle">Administra el acceso y permisos del personal</p>
    </div>
    <ion-button color="primary" (click)="mostrarFormularioCrear()">
      <ion-icon name="add-outline" slot="start"></ion-icon>
      Nuevo Usuario
    </ion-button>
  </div>

  <!-- Lista de usuarios -->
  <div class="usuarios-grid">
    <div *ngFor="let usuario of usuarios" class="usuario-card">
      <div class="card-header">
        <div class="usuario-avatar" [class.admin]="usuario.roles && usuario.roles.includes('ADMIN')" [class.trabajador]="usuario.roles && usuario.roles.includes('TRABAJADOR')">
          <span class="avatar-initial">{{ (usuario.nombre || 'U') | slice:0:1 | uppercase }}</span>
        </div>
        <div class="status-badge" [class.activo]="usuario.activo" [class.inactivo]="!usuario.activo">
          {{usuario.activo ? 'Activo' : 'Inactivo'}}
        </div>
      </div>

      <div class="card-body">
        <h3 class="usuario-nombre">{{usuario.nombre}}</h3>
        <p class="usuario-email">{{usuario.correo}}</p>
        
        <div class="roles-container">
          <div class="role-badge" *ngFor="let rol of usuario.roles">
            {{ rol }}
          </div>
          <div class="role-badge empty" *ngIf="!usuario.roles || usuario.roles.length === 0">
            Sin roles asignados
          </div>
        </div>
      </div>

      <div class="card-actions">
        <ion-button fill="clear" size="small" (click)="editarUsuario(usuario)">
          <ion-icon slot="icon-only" name="create-outline"></ion-icon>
        </ion-button>
        
        <ion-button *ngIf="puedeGestionarPermisos(usuario)" fill="clear" size="small" color="secondary" (click)="gestionarPermisos(usuario)" title="Gestionar Permisos">
          <ion-icon slot="icon-only" name="shield-checkmark-outline"></ion-icon>
        </ion-button>

        <ion-button 
          fill="clear" 
          size="small" 
          [color]="usuario.activo ? 'danger' : 'success'" 
          (click)="toggleEstadoUsuario(usuario)"
          [title]="usuario.activo ? 'Desactivar usuario' : 'Activar usuario'">
          <ion-icon slot="icon-only" name="power-outline"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Estado vacío -->
  <div *ngIf="usuarios.length === 0" class="empty-state">
    <div class="empty-icon">
      <ion-icon name="people-outline"></ion-icon>
    </div>
    <h3>No hay usuarios registrados</h3>
    <p>Comienza creando un nuevo usuario con el botón superior.</p>
  </div>
</div>

<!-- Modal para crear/editar usuario -->
<ion-modal [isOpen]="mostrarFormulario" (didDismiss)="cerrarFormulario()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>{{ isEditMode ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarFormulario()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <form [formGroup]="formgroup" (ngSubmit)="guardarUsuario()">
        <ion-list>
          <ion-item class="form-item">
            <ion-label position="stacked">Nombre Completo</ion-label>
            <ion-input formControlName="nombre" type="text" placeholder="Ej. Juan Pérez"></ion-input>
            <ion-note slot="error" *ngIf="formgroup.get('nombre')?.invalid && formgroup.get('nombre')?.touched">
              Nombre es requerido (min 3 caracteres)
            </ion-note>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">Correo Electrónico</ion-label>
            <ion-input formControlName="correo" type="email" placeholder="juan@ejemplo.com"></ion-input>
            <ion-note slot="error" *ngIf="formgroup.get('correo')?.invalid && formgroup.get('correo')?.touched">
              Correo válido es requerido
            </ion-note>
          </ion-item>

          <ion-item class="form-item" *ngIf="!isEditMode">
            <ion-label position="stacked">Contraseña</ion-label>
            <ion-input formControlName="passwordHash" type="password" placeholder="********"></ion-input>
            <ion-note slot="error" *ngIf="formgroup.get('passwordHash')?.invalid && formgroup.get('passwordHash')?.touched">
              Contraseña requerida (min 6 caracteres)
            </ion-note>
          </ion-item>

          <ion-item class="form-item">
            <ion-label position="stacked">Rol Principal</ion-label>
            <ion-select formControlName="rol" placeholder="Seleccionar rol">
              <ion-select-option *ngFor="let r of rolesCatalog" [value]="r.nombre" [disabled]="!actorAdminPorDefecto && r.nombre === 'ADMIN'">{{ r.nombre }}</ion-select-option>
              <ion-select-option *ngIf="rolesCatalog.length === 0 && actorAdminPorDefecto" value="ADMIN">ADMIN</ion-select-option>
              <ion-select-option *ngIf="rolesCatalog.length === 0" value="TRABAJADOR">TRABAJADOR</ion-select-option>
            </ion-select>
            <ion-note slot="helper">Este rol define el acceso base del usuario.</ion-note>
          </ion-item>

          <ion-item class="form-item" *ngIf="!isEditMode && formgroup.get('rol')?.value === 'ADMIN'">
            <ion-label>Crear nuevo negocio</ion-label>
            <ion-toggle formControlName="crearNuevoNegocio"></ion-toggle>
          </ion-item>

          <ion-item class="form-item" *ngIf="!isEditMode && formgroup.get('rol')?.value === 'ADMIN' && (formgroup.get('crearNuevoNegocio')?.value || !actorNegocioId)">
            <ion-label position="stacked">Nombre del Negocio</ion-label>
            <ion-input formControlName="negocioNombre" type="text" placeholder="Ej. Mi Negocio"></ion-input>
          </ion-item>

          <div class="form-item" *ngIf="!isEditMode">
            <ion-label class="ion-padding-start">Módulos</ion-label>
            <ion-list>
              <ion-item *ngFor="let mod of (formgroup.get('rol')?.value === 'ADMIN' && (formgroup.get('crearNuevoNegocio')?.value || !actorNegocioId) ? catalogModulos : modulosActivosNegocio)">
                <ion-label>
                  <h3>{{ mod.nombre }}</h3>
                  <p>{{ mod.descripcion }}</p>
                </ion-label>
                <ion-checkbox
                  slot="end"
                  [checked]="isModuloSeleccionado(mod.id)"
                  (ionChange)="toggleModuloSeleccion(mod.id, null)">
                </ion-checkbox>
              </ion-item>
            </ion-list>
          </div>

          <ion-item class="form-item">
            <ion-label position="stacked">Estado</ion-label>
            <ion-select formControlName="activo" placeholder="Seleccionar estado">
              <ion-select-option [value]="true">Activo</ion-select-option>
              <ion-select-option [value]="false">Inactivo</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>

        <div class="form-actions">
          <ion-button expand="block" type="submit" color="primary" [disabled]="formgroup.invalid">
            <ion-icon slot="start" [name]="isEditMode ? 'save-outline' : 'add-circle-outline'"></ion-icon>
            {{ isEditMode ? 'Guardar Cambios' : 'Crear Usuario' }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
