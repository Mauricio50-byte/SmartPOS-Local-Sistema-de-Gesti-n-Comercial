<div class="products-wrapper">
    <div class="products-header">
        <ion-segment [value]="segment" (ionChange)="segmentChanged($event)" color="tertiary">
            <ion-segment-button value="info">
                <ion-label>Información de Inventario</ion-label>
            </ion-segment-button>
            <ion-segment-button value="gestion">
                <ion-label>Gestión de Productos</ion-label>
            </ion-segment-button>
        </ion-segment>
    </div>

    <div class="products-content">
        <div *ngIf="segment === 'info'" class="info-view fade-in">
            <div class="search-container">
                <ion-searchbar placeholder="Buscar por nombre..." animated="true" debounce="500"
                    (ionInput)="onSearch($event)">
                </ion-searchbar>
            </div>

            <div class="table-container">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Categoría</th>
                            <th>Marca</th>
                            <th>Precio Venta</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let product of filteredProducts">
                            <td>
                                <strong>{{ product.nombre }}</strong>
                                <small *ngIf="product.sku" style="display: block; color: #666;">SKU: {{ product.sku
                                    }}</small>
                            </td>
                            <td>
                                <ion-badge color="tertiary">{{ product.tipo }}</ion-badge>
                            </td>
                            <td>{{ product.categoria || '-' }}</td>
                            <td>{{ product.marca || '-' }}</td>
                            <td>{{ product.precioVenta | currency:'USD' }}</td>
                            <td>
                                <span [class.low-stock]="product.stockMinimo && product.stock <= product.stockMinimo"
                                    [class.out-of-stock]="product.stock === 0">
                                    {{ product.stock }}
                                </span>
                                <small *ngIf="product.stockMinimo && product.stock <= product.stockMinimo"
                                    style="display: block; color: #e74c3c; font-size: 0.75rem;">
                                    ⚠️ Bajo stock
                                </small>
                            </td>
                            <td>
                                <ion-badge [color]="product.activo ? 'success' : 'medium'">
                                    {{ product.activo ? 'Activo' : 'Inactivo' }}
                                </ion-badge>
                            </td>
                            <td class="actions">
                                <ion-button fill="clear" size="small" (click)="editProduct(product)">
                                    <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                                </ion-button>
                                <ion-button fill="clear" size="small" color="danger" (click)="deleteConfirm(product)">
                                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                </ion-button>
                            </td>
                        </tr>
                        <tr *ngIf="filteredProducts.length === 0">
                            <td colspan="8" class="empty-cell">No se encontraron productos.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div *ngIf="segment === 'gestion'" class="gestion-view fade-in">
            <div class="form-card">
                <h2>{{ isEditing ? 'Editar Producto' : 'Nuevo Producto' }}</h2>

                <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
                    <!-- TIPO DE ITEM -->
                    <div class="form-section tipo-section">
                        <h3>Tipo de Producto</h3>

                        <ion-item class="input-item">
                            <ion-label position="stacked">Seleccione el tipo de producto *</ion-label>
                            <ion-select formControlName="tipo" placeholder="Seleccionar tipo">
                                <ion-select-option value="GENERAL">General</ion-select-option>
                                <ion-select-option value="ROPA" *ngIf="isModuleActive('ropa')">Ropa y Accesorios</ion-select-option>
                                <ion-select-option value="ALIMENTO" *ngIf="isModuleActive('alimentos')">Alimentos y Perecederos</ion-select-option>
                                <ion-select-option value="SERVICIO" *ngIf="isModuleActive('servicios')">Servicios</ion-select-option>
                                <ion-select-option value="FARMACIA" *ngIf="isModuleActive('farmacia')">Farmacia</ion-select-option>
                                <ion-select-option value="PAPELERIA" *ngIf="isModuleActive('papeleria')">Papelería</ion-select-option>
                                <ion-select-option value="RESTAURANTE" *ngIf="isModuleActive('restaurante')">Restaurante</ion-select-option>
                            </ion-select>
                        </ion-item>
                    </div>

                    <!-- IDENTIFICACIÓN -->
                    <div class="form-section">
                        <h3>Identificación</h3>

                        <ion-item class="input-item">
                            <ion-label position="stacked">Nombre del Producto *</ion-label>
                            <ion-input formControlName="nombre"
                                placeholder="Ej. Camisa Polo, Manzanas, Corte de Cabello"></ion-input>
                        </ion-item>
                        <div class="error-msg"
                            *ngIf="productForm.get('nombre')?.touched && productForm.get('nombre')?.invalid">
                            El nombre es requerido (min 3 caracteres).
                        </div>

                        <ion-item class="input-item">
                            <ion-label position="stacked">SKU / Código Interno</ion-label>
                            <ion-input formControlName="sku" placeholder="Ej. CAM-001"></ion-input>
                        </ion-item>
                    </div>

                    <!-- DESCRIPCIÓN -->
                    <div class="form-section">
                        <h3>Descripción</h3>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Descripción</ion-label>
                            <ion-textarea formControlName="descripcion" rows="3"></ion-textarea>
                        </ion-item>
                        <ion-item class="input-item">
                            <ion-label position="stacked">URL de Imagen</ion-label>
                            <ion-input formControlName="imagen"></ion-input>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: ROPA -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'ROPA'">
                        <h3>Detalles de Ropa</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Talla</ion-label>
                                <ion-input formControlName="talla" placeholder="S, M, L, XL"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Color</ion-label>
                                <ion-input formControlName="color" placeholder="Rojo, Azul"></ion-input>
                            </ion-item>
                        </div>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Material</ion-label>
                                <ion-input formControlName="material" placeholder="Algodón, Poliéster"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Género</ion-label>
                                <ion-select formControlName="genero" placeholder="Seleccionar">
                                    <ion-select-option value="Hombre">Hombre</ion-select-option>
                                    <ion-select-option value="Mujer">Mujer</ion-select-option>
                                    <ion-select-option value="Unisex">Unisex</ion-select-option>
                                    <ion-select-option value="Niño">Niño</ion-select-option>
                                    <ion-select-option value="Niña">Niña</ion-select-option>
                                </ion-select>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Temporada</ion-label>
                            <ion-input formControlName="temporada" placeholder="Verano 2025"></ion-input>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: ALIMENTOS -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'ALIMENTO'">
                        <h3>Detalles de Alimentos</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Fecha Vencimiento</ion-label>
                                <ion-input type="date" formControlName="fechaVencimiento"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Lote</ion-label>
                                <ion-input formControlName="lote"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Registro Sanitario</ion-label>
                            <ion-input formControlName="registroSanitario"></ion-input>
                        </ion-item>
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Es Perecedero</ion-label>
                            <ion-toggle slot="end" formControlName="esPerecedero"></ion-toggle>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: SERVICIOS -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'SERVICIO'">
                        <h3>Detalles de Servicio</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Duración (min)</ion-label>
                                <ion-input type="number" formControlName="duracion"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Responsable</ion-label>
                                <ion-input formControlName="responsable" placeholder="Nombre del encargado"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Requiere Cita</ion-label>
                            <ion-toggle slot="end" formControlName="requiereCita"></ion-toggle>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: FARMACIA -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'FARMACIA'">
                        <h3>Detalles de Farmacia</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Componente Activo</ion-label>
                                <ion-input formControlName="componenteActivo" placeholder="Ej. Acetaminofén"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Laboratorio</ion-label>
                                <ion-input formControlName="laboratorio" placeholder="Ej. MK, Genfar"></ion-input>
                            </ion-item>
                        </div>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Presentación</ion-label>
                                <ion-input formControlName="presentacion" placeholder="Ej. Tableta, Jarabe"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Dosis</ion-label>
                                <ion-input formControlName="dosis" placeholder="Ej. 500mg"></ion-input>
                            </ion-item>
                        </div>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Fecha Vencimiento</ion-label>
                                <ion-input type="date" formControlName="fechaVencimiento"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Lote</ion-label>
                                <ion-input formControlName="lote"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Registro Invima</ion-label>
                            <ion-input formControlName="registroInvima"></ion-input>
                        </ion-item>
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Requiere Receta</ion-label>
                            <ion-toggle slot="end" formControlName="requiereReceta"></ion-toggle>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: PAPELERÍA -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'PAPELERIA'">
                        <h3>Detalles de Papelería</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Tipo de Papel</ion-label>
                                <ion-input formControlName="tipoPapel" placeholder="Ej. Bond, Periódico"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Gramaje</ion-label>
                                <ion-input formControlName="gramaje" placeholder="Ej. 75g"></ion-input>
                            </ion-item>
                        </div>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Dimensiones</ion-label>
                                <ion-input formControlName="dimensiones" placeholder="Ej. Carta, Oficio"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Material</ion-label>
                                <ion-input formControlName="material" placeholder="Ej. Plástico, Metal"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Es Kit</ion-label>
                            <ion-toggle slot="end" formControlName="esKit"></ion-toggle>
                        </ion-item>
                    </div>

                    <!-- CAMPOS ESPECÍFICOS: RESTAURANTE -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value === 'RESTAURANTE'">
                        <h3>Detalles de Restaurante</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Tiempo Preparación (min)</ion-label>
                                <ion-input type="number" formControlName="tiempoPreparacion" placeholder="15"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Calorías (Kcal)</ion-label>
                                <ion-input type="number" formControlName="calorias" placeholder="500"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Ingredientes</ion-label>
                            <ion-textarea formControlName="ingredientes" rows="3" placeholder="Lista de ingredientes..."></ion-textarea>
                        </ion-item>
                        <div class="two-columns">
                            <ion-item lines="none" class="toggle-item">
                                <ion-label>Vegano</ion-label>
                                <ion-toggle slot="end" formControlName="esVegano"></ion-toggle>
                            </ion-item>
                            <ion-item lines="none" class="toggle-item">
                                <ion-label>Vegetariano</ion-label>
                                <ion-toggle slot="end" formControlName="esVegetariano"></ion-toggle>
                            </ion-item>
                        </div>
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Contiene Alcohol</ion-label>
                            <ion-toggle slot="end" formControlName="tieneAlcohol"></ion-toggle>
                        </ion-item>
                    </div>

                    <!-- CATEGORIZACIÓN -->
                    <div class="form-section">
                        <h3>Categorización</h3>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Categoría</ion-label>
                            <ion-input formControlName="categoria"></ion-input>
                        </ion-item>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Marca</ion-label>
                            <ion-input formControlName="marca"></ion-input>
                        </ion-item>
                    </div>

                    <!-- PRECIOS Y COSTOS -->
                    <div class="form-section">
                        <h3>Precios y Costos</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Precio Costo</ion-label>
                                <ion-input type="number" formControlName="precioCosto"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Precio Venta *</ion-label>
                                <ion-input type="number" formControlName="precioVenta"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">IVA (%)</ion-label>
                            <ion-input type="number" formControlName="iva"></ion-input>
                        </ion-item>
                    </div>

                    <!-- INVENTARIO -->
                    <div class="form-section" *ngIf="productForm.get('tipo')?.value !== 'SERVICIO'">
                        <h3>Inventario</h3>
                        <div class="two-columns">
                            <ion-item class="input-item">
                                <ion-label position="stacked">Stock Actual *</ion-label>
                                <ion-input type="number" formControlName="stock"></ion-input>
                            </ion-item>
                            <ion-item class="input-item">
                                <ion-label position="stacked">Stock Mínimo</ion-label>
                                <ion-input type="number" formControlName="stockMinimo"></ion-input>
                            </ion-item>
                        </div>
                        <ion-item class="input-item">
                            <ion-label position="stacked">Unidad de Medida</ion-label>
                            <ion-input formControlName="unidadMedida" placeholder="Ej. Unidad, Caja, Paquete, Kg, Litro"></ion-input>
                        </ion-item>
                    </div>

                    <!-- ESTADO -->
                    <div class="form-section">
                        <ion-item lines="none" class="toggle-item">
                            <ion-label>Producto Activo</ion-label>
                            <ion-toggle slot="end" formControlName="activo"></ion-toggle>
                        </ion-item>
                    </div>

                    <div class="form-actions">
                        <ion-button type="button" fill="outline" color="medium" (click)="resetForm()">
                            Cancelar
                        </ion-button>
                        <ion-button type="submit" [disabled]="productForm.invalid">
                            {{ isEditing ? 'Actualizar' : 'Guardar' }}
                        </ion-button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
