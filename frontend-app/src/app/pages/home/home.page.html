<ion-split-pane contentId="home-content" when="lg">
  <ion-menu contentId="home-content" type="overlay">
    <ion-content class="sidebar">
      <div class="brand">
        <div class="brand-icon">
          <ion-icon name="storefront"></ion-icon>
        </div>
        <div class="brand-info">
          <div class="brand-name">SMARTPOS</div>
          <div class="brand-sub">PRO</div>
        </div>
      </div>
      <ion-list lines="none">
        <ion-item button [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" title="Inicio"
          aria-label="Inicio">
          <ion-icon slot="start" name="home-outline"></ion-icon>
          <ion-label>Dashboard</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('inventario') || hasModule('productos') || hasPermission('VER_INVENTARIO')" button [class.active]="currentView === 'productos'"
          (click)="setView('productos')" title="Productos" aria-label="Productos">
          <ion-icon slot="start" name="cube-outline"></ion-icon>
          <ion-label>Productos</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('ventas') || hasPermission('VENDER') || hasPermission('VER_VENTAS')" button [class.active]="currentView === 'ventas'"
          (click)="setView('ventas')" title="Ventas" aria-label="Ventas">
          <ion-icon slot="start" name="cart-outline"></ion-icon>
          <ion-label>Ventas</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('usuarios') || hasPermission('VER_USUARIOS')" button [class.active]="currentView === 'users'"
          (click)="setView('users')" title="Usuarios" aria-label="Usuarios">
          <ion-icon slot="start" name="people-circle-outline"></ion-icon>
          <ion-label>Usuarios</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('clientes') || hasPermission('VER_CLIENTES')" button [class.active]="currentView === 'clientes'" (click)="setView('clientes')" title="Clientes" aria-label="Clientes">
          <ion-icon slot="start" name="people-outline"></ion-icon>
          <ion-label>Clientes</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('modulos') || hasPermission('GESTION_MODULOS')" button [class.active]="currentView === 'modulos'"
          (click)="setView('modulos')" title="Módulos" aria-label="Módulos">
          <ion-icon slot="start" name="grid-outline"></ion-icon>
          <ion-label>Módulos</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('finanzas') || hasPermission('VER_FINANZAS')" button [class.active]="currentView === 'finanzas'"
          (click)="setView('finanzas')" title="Finanzas" aria-label="Finanzas">
          <ion-icon slot="start" name="cash-outline"></ion-icon>
          <ion-label>Finanzas</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('reportes') || hasPermission('VER_REPORTES')" button [class.active]="currentView === 'reportes'"
          (click)="setView('reportes')" title="Reportes" aria-label="Reportes">
          <ion-icon slot="start" name="bar-chart-outline"></ion-icon>
          <ion-label>Reportes</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('configuracion') || hasPermission('VER_CONFIGURACION')" button [class.active]="currentView === 'configuracion'"
          (click)="setView('configuracion')" title="Configuración" aria-label="Configuración">
          <ion-icon slot="start" name="settings-outline"></ion-icon>
          <ion-label>Configuración</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ion-menu>

  <ion-content id="home-content" [fullscreen]="true" class="dashboard">
    <ion-header class="topbar" [translucent]="false">
      <ion-toolbar style="--background: #134e4a; --color: white;">
        <!-- Dark teal/green hardcoded for safety against 'dark' attribute -->
        <ion-buttons slot="start">
          <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <ion-title>{{ pageTitle }}</ion-title>
        <ion-buttons slot="end">
          <!-- Botón de conexión QR -->
          <ion-button class="header-action-btn desktop-only" *ngIf="hasPermission('ADMIN')" aria-label="Conectar Dispositivo" (click)="conectarDispositivo()">
            <ion-icon name="qr-code-outline"></ion-icon>
          </ion-button>

          <!-- Botón de conexión/push -->
          <ion-button class="header-action-btn desktop-only" aria-label="Activar push" (click)="enablePush()">
            <ion-icon name="radio-outline"></ion-icon>
          </ion-button>

          <ion-button aria-label="Notificaciones">
            <ion-icon name="notifications-outline"></ion-icon>
          </ion-button>

          <div class="user-profile-widget">
            <ng-container *ngIf="currentUser; else loadingTemplate">
              <div class="user-details">
                <span class="user-name">{{ currentUser.nombre }}</span>
                <span class="user-role">{{ currentUser.roles[0] || 'Usuario' }}</span>
              </div>
              <div class="user-avatar">
                <span>{{ currentUser.nombre.charAt(0).toUpperCase() }}</span>
              </div>
            </ng-container>

            <ng-template #loadingTemplate>
              <div class="user-details" style="opacity: 0.5;">
                <span class="user-name">Cargando...</span>
              </div>
              <div class="user-avatar" style="background: #e0e0e0;">
                <ion-spinner name="dots" color="primary" style="transform: scale(0.5);"></ion-spinner>
              </div>
            </ng-template>

            <ion-button fill="clear" class="logout-btn" (click)="logout()" title="Cerrar Sesión">
              <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <div class="content-container">
      <app-dashboard *ngIf="currentView === 'dashboard'" (navigate)="setView($event)"></app-dashboard>
      <app-users *ngIf="currentView === 'users'"></app-users>
      <app-ventas *ngIf="currentView === 'ventas'"></app-ventas>
      <app-productos *ngIf="currentView === 'productos'"></app-productos>
      <app-clientes *ngIf="currentView === 'clientes'"></app-clientes>
      <app-modulos *ngIf="currentView === 'modulos'"></app-modulos>
      <app-finanzas *ngIf="currentView === 'finanzas'"></app-finanzas>
      <app-reportes *ngIf="currentView === 'reportes'"></app-reportes>
      <app-configuracion *ngIf="currentView === 'configuracion'"></app-configuracion>
    </div>

    <div class="mobile-tabbar" role="tablist" aria-label="Navegación inferior">
      <button class="item" [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" role="tab"
        [attr.aria-selected]="currentView === 'dashboard'">
        <ion-icon name="home-outline"></ion-icon>
        <span>Inicio</span>
      </button>

      <button class="item" *ngIf="hasModule('inventario') || hasModule('productos') || hasPermission('GESTION_INVENTARIO')" [class.active]="currentView === 'productos'"
        (click)="setView('productos')" role="tab" [attr.aria-selected]="currentView === 'productos'">
        <ion-icon name="cube-outline"></ion-icon>
        <span>Prod.</span>
      </button>

      <button class="item" *ngIf="hasModule('ventas') || hasPermission('VENDER')" [class.active]="currentView === 'ventas'"
        (click)="setView('ventas')" role="tab" [attr.aria-selected]="currentView === 'ventas'">
        <ion-icon name="cart-outline"></ion-icon>
        <span>Ventas</span>
      </button>

      <button class="item" *ngIf="hasModule('usuarios') || hasPermission('GESTION_USUARIOS')" [class.active]="currentView === 'users'"
        (click)="setView('users')" role="tab" [attr.aria-selected]="currentView === 'users'">
        <ion-icon name="people-circle-outline"></ion-icon>
        <span>Users</span>
      </button>

      <button class="item" *ngIf="hasModule('clientes') || hasPermission('GESTION_CLIENTES')" [class.active]="currentView === 'clientes'"
        (click)="setView('clientes')" role="tab" [attr.aria-selected]="currentView === 'clientes'">
        <ion-icon name="people-outline"></ion-icon>
        <span>Clientes</span>
      </button>

      <button class="item" *ngIf="hasModule('modulos') || hasPermission('ADMIN')" [class.active]="currentView === 'modulos'"
        (click)="setView('modulos')" role="tab" [attr.aria-selected]="currentView === 'modulos'">
        <ion-icon name="grid-outline"></ion-icon>
        <span>Módulos</span>
      </button>

      <button class="item" *ngIf="hasModule('finanzas') || hasPermission('ADMIN') || hasPermission('GESTION_FINANZAS')"
        [class.active]="currentView === 'finanzas'" (click)="setView('finanzas')" role="tab"
        [attr.aria-selected]="currentView === 'finanzas'">
        <ion-icon name="cash-outline"></ion-icon>
        <span>Finanzas</span>
      </button>

      <button class="item" *ngIf="hasModule('configuracion') || hasPermission('ADMIN')" role="tab"
        [class.active]="currentView === 'configuracion'" (click)="setView('configuracion')" [attr.aria-selected]="currentView === 'configuracion'">
        <ion-icon name="settings-outline"></ion-icon>
        <span>Config.</span>
      </button>
    </div>
  </ion-content>
</ion-split-pane>