<ion-split-pane contentId="home-content" when="lg">
  <ion-menu contentId="home-content" type="overlay">
    <ion-content class="sidebar">
      <div class="brand">
        <div class="brand-icon">
          <ion-icon name="storefront"></ion-icon>
        </div>
        <div class="brand-info">
          <div class="brand-name">SMARTPOS</div>
          <div class="brand-sub">PRO</div>
        </div>
      </div>
      <ion-list lines="none">
        <ion-item button [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" title="Inicio"
          aria-label="Inicio">
          <ion-icon slot="start" name="home-outline"></ion-icon>
          <ion-label>Dashboard</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('inventario') || hasModule('productos') || hasPermission('VER_INVENTARIO')" button [class.active]="currentView === 'productos'"
          (click)="setView('productos')" title="Productos" aria-label="Productos">
          <ion-icon slot="start" name="cube-outline"></ion-icon>
          <ion-label>Productos</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('ventas') || hasPermission('VENDER') || hasPermission('VER_VENTAS')" button [class.active]="currentView === 'ventas'"
          (click)="setView('ventas')" title="Ventas" aria-label="Ventas">
          <ion-icon slot="start" name="cart-outline"></ion-icon>
          <ion-label>Ventas</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('usuarios') || hasPermission('VER_USUARIOS')" button [class.active]="currentView === 'users'"
          (click)="setView('users')" title="Usuarios" aria-label="Usuarios">
          <ion-icon slot="start" name="people-circle-outline"></ion-icon>
          <ion-label>Usuarios</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('clientes') || hasPermission('VER_CLIENTES')" button [class.active]="currentView === 'clientes'" (click)="setView('clientes')" title="Clientes" aria-label="Clientes">
          <ion-icon slot="start" name="people-outline"></ion-icon>
          <ion-label>Clientes</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('modulos') || hasPermission('GESTION_MODULOS')" button [class.active]="currentView === 'modulos'"
          (click)="setView('modulos')" title="Módulos" aria-label="Módulos">
          <ion-icon slot="start" name="grid-outline"></ion-icon>
          <ion-label>Módulos</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('finanzas') || hasPermission('VER_FINANZAS')" button [class.active]="currentView === 'finanzas'"
          (click)="setView('finanzas')" title="Finanzas" aria-label="Finanzas">
          <ion-icon slot="start" name="cash-outline"></ion-icon>
          <ion-label>Finanzas</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('reportes') || hasPermission('VER_REPORTES')" button [class.active]="currentView === 'reportes'"
          (click)="setView('reportes')" title="Reportes" aria-label="Reportes">
          <ion-icon slot="start" name="bar-chart-outline"></ion-icon>
          <ion-label>Reportes</ion-label>
        </ion-item>

        <ion-item *ngIf="hasModule('configuracion') || hasPermission('VER_CONFIGURACION')" button [class.active]="currentView === 'configuracion'"
          (click)="setView('configuracion')" title="Configuración" aria-label="Configuración">
          <ion-icon slot="start" name="settings-outline"></ion-icon>
          <ion-label>Configuración</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ion-menu>

  <ion-content id="home-content" [fullscreen]="true" class="dashboard">
    <ion-header class="topbar" [translucent]="false">
      <ion-toolbar style="--background: #134e4a; --color: white;">
        <!-- Dark teal/green hardcoded for safety against 'dark' attribute -->
        <ion-buttons slot="start">
          <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <ion-title>{{ pageTitle }}</ion-title>
        <ion-buttons slot="end">
          <!-- Botón de conexión QR -->
          <ion-button class="header-action-btn desktop-only" *ngIf="hasPermission('ADMIN')" aria-label="Conectar Dispositivo" (click)="conectarDispositivo()">
            <ion-icon name="qr-code-outline"></ion-icon>
          </ion-button>

          <ion-button id="notifications-trigger" aria-label="Notificaciones" class="notification-btn">
            <ion-icon name="notifications-outline"></ion-icon>
            <ion-badge *ngIf="(unreadCount$ | async) as count" color="danger" class="notification-badge">
              {{ count > 9 ? '9+' : count }}
            </ion-badge>
          </ion-button>

          <ion-popover trigger="notifications-trigger" dismissOnSelect="true" class="notification-popover" side="bottom" alignment="end" [showBackdrop]="false">
            <ng-template>
              <div class="notification-container">
                <div class="notification-header">
                  <h3>Notificaciones</h3>
                  <ion-button fill="clear" size="small" (click)="markAllRead()" [disabled]="(unreadCount$ | async) === 0">
                    Marcar leídas
                  </ion-button>
                </div>
                
                <div class="notification-list-wrapper">
                  <ion-list lines="full" class="ion-no-padding">
                    <ion-item button *ngFor="let n of notifications$ | async" 
                              [class.unread]="!n.read" 
                              (click)="markAsRead(n)"
                              detail="false"
                              class="notification-item">
                      <div class="notif-icon-wrapper" slot="start" [class]="n.type">
                        <ion-icon [name]="getIconForType(n.type)"></ion-icon>
                      </div>
                      <ion-label class="ion-text-wrap">
                        <div class="notif-top">
                          <span class="notif-title">{{ n.title }}</span>
                          <span class="notif-time">{{ n.timestamp | date:'shortTime' }}</span>
                        </div>
                        <p class="notif-msg">{{ n.message }}</p>
                      </ion-label>
                      <ion-button slot="end" fill="clear" color="medium" size="small" (click)="removeNotification($event, n.id)">
                        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                    </ion-item>

                    <div class="empty-notifications" *ngIf="(notifications$ | async)?.length === 0">
                      <ion-icon name="notifications-off-outline"></ion-icon>
                      <p>No tienes notificaciones</p>
                    </div>
                  </ion-list>
                </div>
              </div>
            </ng-template>
          </ion-popover>

          <div class="user-profile-widget">
            <ng-container *ngIf="currentUser; else loadingTemplate">
              <div class="user-details">
                <span class="user-name">{{ currentUser.nombre }}</span>
                <span class="user-role">{{ currentUser.roles[0] || 'Usuario' }}</span>
              </div>
              <div class="user-avatar">
                <span>{{ currentUser.nombre.charAt(0).toUpperCase() }}</span>
              </div>
            </ng-container>

            <ng-template #loadingTemplate>
              <div class="user-details" style="opacity: 0.5;">
                <span class="user-name">Cargando...</span>
              </div>
              <div class="user-avatar" style="background: #e0e0e0;">
                <ion-spinner name="dots" color="primary" style="transform: scale(0.5);"></ion-spinner>
              </div>
            </ng-template>

            <ion-button fill="clear" class="logout-btn" (click)="logout()" title="Cerrar Sesión">
              <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <div class="content-container">
      <app-dashboard *ngIf="currentView === 'dashboard'" (navigate)="setView($event)"></app-dashboard>
      <app-users *ngIf="currentView === 'users'"></app-users>
      <app-ventas *ngIf="currentView === 'ventas'"></app-ventas>
      <app-productos *ngIf="currentView === 'productos'"></app-productos>
      <app-clientes *ngIf="currentView === 'clientes'"></app-clientes>
      <app-modulos *ngIf="currentView === 'modulos'"></app-modulos>
      <app-finanzas *ngIf="currentView === 'finanzas'"></app-finanzas>
      <app-reportes *ngIf="currentView === 'reportes'"></app-reportes>
      <app-configuracion *ngIf="currentView === 'configuracion'"></app-configuracion>
    </div>

    <div class="mobile-tabbar" role="tablist" aria-label="Navegación inferior">
      <button class="item" [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" role="tab"
        [attr.aria-selected]="currentView === 'dashboard'">
        <ion-icon name="home-outline"></ion-icon>
        <span>Inicio</span>
      </button>

      <button class="item" *ngIf="hasModule('inventario') || hasModule('productos') || hasPermission('VER_INVENTARIO') || hasPermission('ADMIN')" [class.active]="currentView === 'productos'"
        (click)="setView('productos')" role="tab" [attr.aria-selected]="currentView === 'productos'">
        <ion-icon name="cube-outline"></ion-icon>
        <span>Prod.</span>
      </button>

      <button class="item" *ngIf="hasModule('ventas') || hasPermission('VENDER') || hasPermission('VER_VENTAS') || hasPermission('ADMIN')" [class.active]="currentView === 'ventas'"
        (click)="setView('ventas')" role="tab" [attr.aria-selected]="currentView === 'ventas'">
        <ion-icon name="cart-outline"></ion-icon>
        <span>Ventas</span>
      </button>

      <button class="item" *ngIf="hasModule('usuarios') || hasPermission('VER_USUARIOS') || hasPermission('ADMIN')" [class.active]="currentView === 'users'"
        (click)="setView('users')" role="tab" [attr.aria-selected]="currentView === 'users'">
        <ion-icon name="people-circle-outline"></ion-icon>
        <span>Users</span>
      </button>

      <button class="item" *ngIf="hasModule('clientes') || hasPermission('VER_CLIENTES') || hasPermission('ADMIN')" [class.active]="currentView === 'clientes'"
        (click)="setView('clientes')" role="tab" [attr.aria-selected]="currentView === 'clientes'">
        <ion-icon name="people-outline"></ion-icon>
        <span>Clientes</span>
      </button>

      <button class="item" *ngIf="hasModule('modulos') || hasPermission('GESTION_MODULOS') || hasPermission('ADMIN')" [class.active]="currentView === 'modulos'"
        (click)="setView('modulos')" role="tab" [attr.aria-selected]="currentView === 'modulos'">
        <ion-icon name="grid-outline"></ion-icon>
        <span>Módulos</span>
      </button>

      <button class="item" *ngIf="hasModule('finanzas') || hasPermission('VER_FINANZAS') || hasPermission('ADMIN')"
        [class.active]="currentView === 'finanzas'" (click)="setView('finanzas')" role="tab"
        [attr.aria-selected]="currentView === 'finanzas'">
        <ion-icon name="cash-outline"></ion-icon>
        <span>Finanzas</span>
      </button>
      
      <button class="item" *ngIf="hasModule('reportes') || hasPermission('VER_REPORTES') || hasPermission('ADMIN')"
        [class.active]="currentView === 'reportes'" (click)="setView('reportes')" role="tab"
        [attr.aria-selected]="currentView === 'reportes'">
        <ion-icon name="bar-chart-outline"></ion-icon>
        <span>Reportes</span>
      </button>

      <button class="item" *ngIf="hasModule('configuracion') || hasPermission('VER_CONFIGURACION') || hasPermission('ADMIN')" role="tab"
        [class.active]="currentView === 'configuracion'" (click)="setView('configuracion')" [attr.aria-selected]="currentView === 'configuracion'">
        <ion-icon name="settings-outline"></ion-icon>
        <span>Config.</span>
      </button>
    </div>
  </ion-content>
</ion-split-pane>
