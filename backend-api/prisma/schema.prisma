generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Usuario {
  id           Int      @id @default(autoincrement())
  nombre       String
  correo       String   @unique
  passwordHash String
  activo       Boolean  @default(true)
  creadoEn     DateTime @default(now())
  ventas       Venta[]
  roles        UsuarioRol[]
  permisos     UsuarioPermiso[]
  logs         AuditLog[]
  pagosGastos  PagoGasto[]
}

// Modelo para gestión de Módulos del Sistema
model Modulo {
  id          String   @id // e.g., "ropa", "alimentos", "servicios"
  nombre      String
  descripcion String?
  activo      Boolean  @default(false)
  version     String   @default("1.0.0")
  config      Json?    // Configuración específica del módulo
  creadoEn    DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

model Producto {
  id           Int      @id @default(autoincrement())
  
  // Tipo de Producto (vinculado al módulo)
  tipo         String   @default("GENERAL") // GENERAL, ROPA, ALIMENTO, SERVICIO
  
  // Identificación
  nombre       String
  sku          String?  @unique
  
  // Descripción
  descripcion  String?
  imagen       String?
  
  // Categorización Global
  categoria    String?
  subcategoria String?
  marca        String?
  
  // Precios y Costos
  precioCosto  Float?   @default(0)
  precioVenta  Float
  descuento    Float?   @default(0)
  
  // Inventario Global
  stock        Int      @default(0)
  stockMinimo  Int?     @default(0)
  unidadMedida String?  @default("UNIDAD")
  
  // Impuestos
  iva          Float?   @default(0)
  
  // Proveedor
  proveedor    String?
  
  // Estado
  activo       Boolean  @default(true)
  
  // Timestamps
  creadoEn     DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  
  // Relaciones con Detalles Específicos (Polimorfismo vía Tablas Opcionales)
  detalleRopa     ProductoRopa?
  detalleAlimento ProductoAlimento?
  detalleServicio ProductoServicio?
  detalleFarmacia ProductoFarmacia?
  detallePapeleria ProductoPapeleria?
  detalleRestaurante ProductoRestaurante?
  
  // Relaciones Generales
  detalles     DetalleVenta[]
}

// Extensión para Ropa y Accesorios
model ProductoRopa {
  id         Int      @id @default(autoincrement())
  productoId Int      @unique
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  talla      String?  // XS, S, M, L, XL, etc.
  color      String?
  material   String?
  genero     String?  // Hombre, Mujer, Unisex, Niño, Niña
  temporada  String?
}

// Extensión para Alimentos y Perecederos
model ProductoAlimento {
  id               Int      @id @default(autoincrement())
  productoId       Int      @unique
  producto         Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  fechaVencimiento DateTime?
  lote             String?
  registroSanitario String?
  ingredientes     String? // Podría ser JSON o Texto
  esPerecedero     Boolean @default(true)
  temperaturaConservacion String?
}

// Extensión para Servicios
model ProductoServicio {
  id           Int      @id @default(autoincrement())
  productoId   Int      @unique
  producto     Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  duracion     Int?     // Duración en minutos
  responsable  String?  // Nombre del encargado o rol requerido
  requiereCita Boolean  @default(false)
  garantiaDias Int?     // Días de garantía del servicio
}

// Extensión para Farmacia
model ProductoFarmacia {
  id               Int      @id @default(autoincrement())
  productoId       Int      @unique
  producto         Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  componenteActivo String?  // Principio activo
  presentacion     String?  // Tableta, Jarabe, Inyección, etc.
  dosis            String?  // 500mg, 10ml, etc.
  laboratorio      String?  // Fabricante
  requiereReceta   Boolean  @default(false)
  fechaVencimiento DateTime?
  lote             String?
  registroInvima   String?
}

// Extensión para Papelería
model ProductoPapeleria {
  id          Int      @id @default(autoincrement())
  productoId  Int      @unique
  producto    Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  tipoPapel   String?  // Bond, Periodico, Cartulina, etc.
  gramaje     String?  // 75g, 90g, etc.
  dimensiones String?  // Carta, Oficio, A4, etc.
  material    String?  // Plástico, Metal, Madera (para útiles)
  esKit       Boolean  @default(false) // Si es un kit escolar, etc.
}

// Extensión para Restaurante
model ProductoRestaurante {
  id                Int      @id @default(autoincrement())
  productoId        Int      @unique
  producto          Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  ingredientes      String?  // Lista de ingredientes principales
  tiempoPreparacion Int?     // Minutos estimados
  esVegano          Boolean  @default(false)
  esVegetariano     Boolean  @default(false)
  tieneAlcohol      Boolean  @default(false)
  calorias          Int?     // Kcal estimadas
}

model Cliente {
  id            Int      @id @default(autoincrement())
  nombre        String
  correo        String?  @unique
  telefono      String?
  cedula        String?  @unique
  direccion     String?
  activo        Boolean  @default(true)
  creditoMaximo Float    @default(0)
  saldoDeuda    Float    @default(0)
  puntos        Int      @default(0)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  
  ventas        Venta[]
  deudas        Deuda[]
  abonos        Abono[]
}

model Venta {
  id            Int           @id @default(autoincrement())
  fecha         DateTime      @default(now())
  total         Float
  clienteId     Int?
  cliente       Cliente?      @relation(fields: [clienteId], references: [id])
  usuarioId     Int
  usuario       Usuario       @relation(fields: [usuarioId], references: [id])
  
  metodoPago    String        @default("EFECTIVO")
  estadoPago    String        @default("PAGADO")
  montoPagado   Float         @default(0)
  saldoPendiente Float        @default(0)
  
  detalles      DetalleVenta[]
  deuda         Deuda?
}

model Rol {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  usuarios    UsuarioRol[]
  permisos    RolPermiso[]
}

model Permiso {
  id          Int          @id @default(autoincrement())
  clave       String       @unique
  descripcion String?
  roles       RolPermiso[]
  usuarios    UsuarioPermiso[]
}

model UsuarioRol {
  usuarioId Int
  rolId     Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  rol       Rol     @relation(fields: [rolId], references: [id])
  @@id([usuarioId, rolId])
}

model RolPermiso {
  rolId     Int
  permisoId Int
  rol       Rol     @relation(fields: [rolId], references: [id])
  permiso   Permiso @relation(fields: [permisoId], references: [id])
  @@id([rolId, permisoId])
}

model UsuarioPermiso {
  usuarioId Int
  permisoId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  permiso   Permiso @relation(fields: [permisoId], references: [id])
  @@id([usuarioId, permisoId])
}

model DetalleVenta {
  id             Int     @id @default(autoincrement())
  ventaId        Int
  productoId     Int
  cantidad       Int
  precioUnitario Float
  subtotal       Float
  venta          Venta   @relation(fields: [ventaId], references: [id])
  producto       Producto @relation(fields: [productoId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  usuarioId Int?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])
  accion    String
  detalle   String?
  fecha     DateTime @default(now())
}

model Deuda {
  id             Int      @id @default(autoincrement())
  clienteId      Int
  cliente        Cliente  @relation(fields: [clienteId], references: [id])
  ventaId        Int      @unique
  venta          Venta    @relation(fields: [ventaId], references: [id])
  montoTotal     Float
  saldoPendiente Float
  estado         String   @default("PENDIENTE")
  fechaCreacion  DateTime @default(now())
  fechaVencimiento DateTime?
  
  abonos         Abono[]
}

model Abono {
  id        Int      @id @default(autoincrement())
  deudaId   Int
  deuda     Deuda    @relation(fields: [deudaId], references: [id])
  clienteId Int
  cliente   Cliente  @relation(fields: [clienteId], references: [id])
  monto     Float
  metodoPago String  @default("EFECTIVO")
  fecha     DateTime @default(now())
  usuarioId Int?
  nota      String?
}

model Gasto {
  id               Int         @id @default(autoincrement())
  proveedor        String
  concepto         String
  montoTotal       Float
  saldoPendiente   Float
  fechaVencimiento DateTime?
  estado           String      @default("PENDIENTE") // PENDIENTE, PAGADO, VENCIDO
  fechaRegistro    DateTime    @default(now())
  categoria        String?
  
  pagos            PagoGasto[]
}

model PagoGasto {
  id            Int      @id @default(autoincrement())
  gastoId       Int
  gasto         Gasto    @relation(fields: [gastoId], references: [id])
  monto         Float
  fecha         DateTime @default(now())
  metodoPago    String   @default("EFECTIVO")
  usuarioId     Int?
  usuario       Usuario? @relation(fields: [usuarioId], references: [id])
  nota          String?
}
